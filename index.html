<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Kiosko POS - Gesti√≥n de Stock</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #fff; --accent: #3498db; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        .sidenav { height: 100%; width: 0; position: fixed; z-index: 1001; top: 0; left: 0; background: #111; transition: 0.3s; padding-top: 60px; overflow-x: hidden; }
        .sidenav a { padding: 15px 25px; text-decoration: none; color: #818181; display: block; border-bottom: 1px solid #222; cursor: pointer; }
        .open-btn { font-size: 24px; cursor: pointer; position: fixed; top: 20px; left: 20px; background: none; border: none; color: white; z-index: 1000; }

        .container { max-width: 900px; margin: 60px auto; }
        .form-card { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 30px; border-bottom: 4px solid var(--accent); }
        
        input { width: 100%; padding: 10px; margin: 8px 0; background: #2d2d2d; border: 1px solid #444; color: white; border-radius: 6px; }
        button.btn-save { width: 100%; padding: 12px; background: var(--accent); border: none; color: white; font-weight: bold; border-radius: 6px; cursor: pointer; }

        /* TABLA DE STOCK */
        table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 12px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #333; }
        th { background: #252525; color: var(--accent); font-size: 0.8rem; letter-spacing: 1px; }
        .alerta-stock { color: #ff4757; font-weight: bold; } /* Rojo si hay poco */
    </style>
</head>
<body>
    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" onclick="closeNav()" style="font-size:30px; position:absolute; top:10px; right:25px; color:white;">&times;</a>
        <a href="ventas.html">üõí Ventas</a>
        <a href="index.html">üì¶ Inventario</a>
        <a href="libreta.html">üìñ Libreta Fiados</a>
        <a href="reportes.html">üìä Reportes</a>
    </div>
    <button class="open-btn" onclick="openNav()">&#9776;</button>

    <div class="container">
        <div class="form-card">
            <h2 style="margin-top:0"><span style="color:var(--accent)">K</span>iosko - Carga de Productos</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input type="text" id="codigo" placeholder="C√≥digo de Barras">
                <input type="text" id="nombre" placeholder="Nombre del Producto">
                <input type="number" id="precio" placeholder="Precio de Venta">
                <input type="number" id="stock" placeholder="Cantidad que entra">
            </div>
            <button class="btn-save" onclick="guardar()">ACTUALIZAR / AGREGAR</button>
        </div>

        <h3>üì¶ Stock Actual</h3>
        <table>
            <thead>
                <tr><th>C√ìDIGO</th><th>PRODUCTO</th><th>PRECIO</th><th>STOCK</th><th>ACCI√ìN</th></tr>
            </thead>
            <tbody id="tabla-stock">
                </tbody>
        </table>
    </div>

    <script>
        const client = supabase.createClient('https://ovctgqmhumlspklhbjhf.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92Y3RncW1odW1sc3BrbGhiamhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMTcyOTEsImV4cCI6MjA4Mzc5MzI5MX0.6PrQwbYrjDZqo_Zku3uM-z7Bt3-Dn59cMbl5l9KAo_Q');
        // OREJA PARA CARGA DE STOCK
client.channel('carga').on('broadcast', { event: 'escaneo' }, (p) => {
    document.getElementById('codigo').value = p.payload.codigo;
    // Opcional: que vibre o haga un sonido la PC si quieres
    console.log("C√≥digo recibido para carga: " + p.payload.codigo);
}).subscribe();
        function openNav() { document.getElementById("mySidenav").style.width = "250px"; }
        function closeNav() { document.getElementById("mySidenav").style.width = "0"; }

        // Cargar la lista apenas abre la p√°gina
        async function cargarInventario() {
            const { data, error } = await client.from('productos').select('*').order('nombre', { ascending: true });
            if (error) return;

            const tbody = document.getElementById('tabla-stock');
            tbody.innerHTML = '';

            data.forEach(p => {
                // Si el stock es menos de 5, lo ponemos en rojo
                const claseStock = p.stock <= 5 ? 'alerta-stock' : '';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${p.codigo_barra}</td>
                        <td>${p.nombre}</td>
                        <td>$${p.precio_venta}</td>
                        <td class="${claseStock}">${p.stock} unidades</td>
                        <td><button onclick="eliminar('${p.id}')" style="background:none; border:none; color:#ff4757; cursor:pointer;">üóëÔ∏è</button></td>
                    </tr>`;
            });
        }

        async function guardar() {
            const cod = document.getElementById('codigo').value;
            const nom = document.getElementById('nombre').value;
            const pre = parseFloat(document.getElementById('precio').value);
            const sto = parseInt(document.getElementById('stock').value);

            if(!cod || !nom) return alert("Completa los datos");

            // Primero vemos si ya existe para sumar el stock
            const { data: existente } = await client.from('productos').select('*').eq('codigo_barra', cod).single();
            
            let nuevoStock = sto;
            if(existente) {
                nuevoStock = existente.stock + sto; // Sumamos lo nuevo a lo que ya hab√≠a
            }

            const { error } = await client.from('productos').upsert([{
                codigo_barra: cod,
                nombre: nom,
                precio_venta: pre,
                stock: nuevoStock
            }], { onConflict: 'codigo_barra' });

            if(!error) {
                alert("Inventario actualizado");
                document.querySelectorAll('input').forEach(i => i.value = '');
                cargarInventario(); // Refrescar la lista
            }
        }

        async function eliminar(id) {
            if(confirm("¬øSeguro quieres borrar este producto?")) {
                await client.from('productos').delete().eq('id', id);
                cargarInventario();
            }
        }

        cargarInventario();
    </script>
</body>
</html>