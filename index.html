<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Kiosko POS - Gesti칩n de Stock</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #fff; --accent: #3498db; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        .sidenav { height: 100%; width: 0; position: fixed; z-index: 1001; top: 0; left: 0; background: #111; transition: 0.3s; padding-top: 60px; overflow-x: hidden; }
        .sidenav a { padding: 15px 25px; text-decoration: none; color: #818181; display: block; border-bottom: 1px solid #222; cursor: pointer; }
        .open-btn { font-size: 24px; cursor: pointer; position: fixed; top: 20px; left: 20px; background: none; border: none; color: white; z-index: 1000; }

        .container { max-width: 900px; margin: 60px auto; }
        .form-card { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 30px; border-bottom: 4px solid var(--accent); }
        
        input { width: 100%; padding: 10px; margin: 8px 0; background: #2d2d2d; border: 1px solid #444; color: white; border-radius: 6px; }
        button.btn-save { width: 100%; padding: 12px; background: var(--accent); border: none; color: white; font-weight: bold; border-radius: 6px; cursor: pointer; }

        /* TABLA DE STOCK */
        table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 12px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #333; }
        th { background: #252525; color: var(--accent); font-size: 0.8rem; letter-spacing: 1px; }
        .alerta-stock { color: #ff4757; font-weight: bold; } /* Rojo si hay poco */
    </style>
</head>
<body>
    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" onclick="closeNav()" style="font-size:30px; position:absolute; top:10px; right:25px; color:white;">&times;</a>
        <a href="ventas.html">游 Ventas</a>
        <a href="index.html">游닍 Inventario</a>
        <a href="libreta.html">游닀 Libreta Fiados</a>
        <a href="reportes.html">游늵 Reportes</a>
        <a href="usuario.html">游논 Gesti칩n de Personal</a> 
        <a href="#" onclick="cerrarSesion()" style="color: #ff4757;">游뛁 Cerrar Sesi칩n</a>
    </div>
    <button class="open-btn" onclick="openNav()">&#9776;</button>

    <div class="container">
        <div class="form-card">
            <h2 style="margin-top:0"><span style="color:var(--accent)">K</span>iosko - Carga de Productos</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input type="text" id="codigo" placeholder="C칩digo de Barras">
                <input type="text" id="nombre" placeholder="Nombre del Producto">
                <input type="number" id="precio" placeholder="Precio de Venta">
                <input type="number" id="stock" placeholder="Cantidad que entra">
            </div>
            <button class="btn-save" onclick="guardar()">ACTUALIZAR / AGREGAR</button>
        </div>

        <h3>游닍 Stock Actual</h3>
        <table>
            <thead>
                <tr><th>C칍DIGO</th><th>PRODUCTO</th><th>PRECIO</th><th>STOCK</th><th>ACCI칍N</th></tr>
            </thead>
            <tbody id="tabla-stock">
                </tbody>
        </table>
    </div>

    <script>
        const client = supabase.createClient('https://ovctgqmhumlspklhbjhf.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92Y3RncW1odW1sc3BrbGhiamhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMTcyOTEsImV4cCI6MjA4Mzc5MzI5MX0.6PrQwbYrjDZqo_Zku3uM-z7Bt3-Dn59cMbl5l9KAo_Q');
        function verificarAcceso() {
    const rol = localStorage.getItem('rol');
    
    // Si no est치 logueado, mandarlo al login
    if (!rol) { window.location.href = 'login.html'; return; }

    const menuAdmin = document.getElementById('menu-admin');
    
    // Rita (empleado) NO ve el men칰 admin
    // Zoe (encargada) y Due침o S칈 ven todo
    if (rol === 'due침o' || rol === 'encargada') {
        if (menuAdmin) menuAdmin.style.display = 'block';
    } else {
        if (menuAdmin) menuAdmin.style.display = 'none';
        
        // Bloqueo de p치gina si intenta entrar por URL
        const paginasProhibidas = ['index.html', 'reportes.html', 'usuarios.html', 'libreta.html'];
        if (paginasProhibidas.some(pag => window.location.pathname.includes(pag))) {
            window.location.href = 'ventas.html';
        }
    }
}
    document.getElementById('nombre-vendedor').innerText = vendedor;
        // --- OREJA PARA CARGA DE STOCK ---
client.channel('carga').on('broadcast', { event: 'escaneo' }, async (p) => {
    const codigoEscaneado = p.payload.codigo;
    
    // 1. Ponemos el c칩digo en el cuadro de texto
    document.getElementById('codigo').value = codigoEscaneado;

    // 2. Buscamos PRIMERO si ya lo ten칠s en tu inventario (productos)
    const { data: local } = await client
        .from('productos')
        .select('*')
        .eq('codigo_barra', codigoEscaneado)
        .single();

    if (local) {
        // Si ya lo ten칠s, rellena todo para que solo edites si hace falta
        document.getElementById('nombre').value = local.nombre;
        document.getElementById('precio').value = local.precio_venta;
        // El stock lo dejamos vac칤o para que sumes lo que entra nuevo
        document.getElementById('stock').focus(); 
        console.log("Producto encontrado en tu inventario local.");
    } else {
        // 3. SI NO EST츼 en tu inventario, busca en la TABLA MAESTRA
        const { data: maestra } = await client
            .from('maestra_ar')
            .select('nombre')
            .eq('codigo_barra', codigoEscaneado)
            .single();

        if (maestra) {
            // Si est치 en la maestra, te "regala" el nombre del producto
            document.getElementById('nombre').value = maestra.nombre;
            document.getElementById('precio').focus(); // Salta al precio
            console.log("Producto nuevo detectado en la Base Maestra.");
        } else {
            // 4. Si no est치 en ning칰n lado, te toca escribir el nombre
            document.getElementById('nombre').value = '';
            document.getElementById('nombre').focus();
            console.log("C칩digo desconocido. Se debe cargar manualmente.");
        }
    }
}).subscribe();

        async function guardar() {
            const cod = document.getElementById('codigo').value;
            const nom = document.getElementById('nombre').value;
            const pre = parseFloat(document.getElementById('precio').value);
            const sto = parseInt(document.getElementById('stock').value);

            if(!cod || !nom) return alert("Completa los datos");

            // Primero vemos si ya existe para sumar el stock
            const { data: existente } = await client.from('productos').select('*').eq('codigo_barra', cod).single();
            
            let nuevoStock = sto;
            if(existente) {
                nuevoStock = existente.stock + sto; // Sumamos lo nuevo a lo que ya hab칤a
            }

            const { error } = await client.from('productos').upsert([{
                codigo_barra: cod,
                nombre: nom,
                precio_venta: pre,
                stock: nuevoStock
            }], { onConflict: 'codigo_barra' });

            if(!error) {
                alert("Inventario actualizado");
                document.querySelectorAll('input').forEach(i => i.value = '');
                cargarInventario(); // Refrescar la lista
            }
        }

        async function eliminar(id) {
            if(confirm("쯉eguro quieres borrar este producto?")) {
                await client.from('productos').delete().eq('id', id);
                cargarInventario();
            }
        }

        cargarInventario();
        function cerrarSesion() {
    localStorage.clear(); // Borra el usuario y el rol de la memoria
    window.location.href = 'login.html'; // Manda al login
}
    </script>
</body>
</html>