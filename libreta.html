<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>KIOSCO POS - Libreta</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #fff; --accent: #3498db; --success: #2ecc71; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        /* --- ESTILOS DEL MENU LATERAL --- */
        .sidenav { height: 100%; width: 0; position: fixed; z-index: 1001; top: 0; left: 0; background: #111; transition: 0.3s; padding-top: 60px; overflow-x: hidden; }
        .sidenav a { padding: 15px 25px; text-decoration: none; font-size: 1.1rem; color: #818181; display: block; border-bottom: 1px solid #222; cursor: pointer; }
        .sidenav a:hover { color: var(--success); }
        .open-btn { font-size: 24px; cursor: pointer; position: fixed; top: 20px; left: 20px; background: none; border: none; color: white; z-index: 1000; }

        .container { max-width: 900px; margin: 60px auto 0; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border-bottom: 4px solid var(--accent); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; color: #888; padding: 12px; border-bottom: 1px solid #333; }
        td { padding: 12px; border-bottom: 1px solid #222; }

        .btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-right: 5px; }
        .btn-abono { background: var(--accent); color: white; }
        .btn-liquidar { background: var(--success); color: white; }
        .total-deuda { color: var(--danger); font-weight: bold; font-size: 1.2rem; }
    </style>
</head>
<body>

    <button class="open-btn" onclick="openNav()">&#9776;</button>

    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" onclick="closeNav()" style="font-size:30px; position:absolute; top:10px; right:25px; color:white;">&times;</a>
            <a href="ventas.html">ðŸ›’ Ventas</a>
            <div id="menu-admin" style="display: none;">
            <a href="index.html">ðŸ“¦ Inventario</a>
            <a href="libreta.html" style="color: var(--success);">ðŸ“– Libreta Fiados</a>
            <a href="reportes.html">ðŸ“Š Reportes</a>
             <a href="usuario.html">ðŸ‘¥ GestiÃ³n de Personal</a>
        </div>
        <a href="#" onclick="cerrarSesion()" style="color: #ff4757; margin-top: 20px;">ðŸšª Cerrar SesiÃ³n</a>
    </div>

    <div class="container">
        <div class="card">
            <h1 style="margin-top:0">ðŸ“– Cuenta Corriente</h1>
            <p style="color:#888">Suma de deudas por cliente y pagos realizados.</p>
            
            <table>
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Estado</th>
                        <th>Saldo Total</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="cuerpo-libreta">
                    <tr><td colspan="4" style="text-align:center;">Cargando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const client = supabase.createClient('https://ovctgqmhumlspklhbjhf.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92Y3RncW1odW1sc3BrbGhiamhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMTcyOTEsImV4cCI6MjA4Mzc5MzI5MX0.6PrQwbYrjDZqo_Zku3uM-z7Bt3-Dn59cMbl5l9KAo_Q');

        // --- 1. FUNCIONES DEL MENU (AQUÃ ESTÃ EL ARREGLO) ---
        function openNav() { document.getElementById("mySidenav").style.width = "250px"; }
        function closeNav() { document.getElementById("mySidenav").style.width = "0"; }
        
        function verificarAcceso() {
            const rol = localStorage.getItem('rol');
            if (!rol) { window.location.href = 'login.html'; return; }
            const menuAdmin = document.getElementById('menu-admin');
            if (rol === 'dueÃ±o' || rol === 'encargada') { if (menuAdmin) menuAdmin.style.display = 'block'; }
        }

        function cerrarSesion() { localStorage.clear(); window.location.href = 'login.html'; }

        // --- 2. LÃ“GICA DE LA LIBRETA ---
        async function cargarCuentas() {
            const { data, error } = await client
                .from('ventas')
                .select('*')
                .eq('metodo_pago', 'libreta');

            if (error) return;

            const cuentas = {};
            data.forEach(v => {
                const nombre = v.cliente_nombre || "Sin Nombre";
                if (!cuentas[nombre]) cuentas[nombre] = { total: 0, pagado: 0 };
                cuentas[nombre].total += (v.total || 0);
                cuentas[nombre].pagado += (v.pago_parcial || 0);
            });

            const tbody = document.getElementById('cuerpo-libreta');
            tbody.innerHTML = '';

            for (const nombre in cuentas) {
                const saldo = cuentas[nombre].total - cuentas[nombre].pagado;
                if (saldo <= 0.1) continue;

                tbody.innerHTML += `
                    <tr>
                        <td><b>${nombre}</b></td>
                        <td style="font-size:0.8rem; color:#888;">
                            Deuda: $${cuentas[nombre].total.toFixed(2)}<br>
                            Abonos: $${cuentas[nombre].pagado.toFixed(2)}
                        </td>
                        <td class="total-deuda">$${saldo.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-abono" onclick="hacerAbono('${nombre}', ${saldo})">ðŸ’¸ Abonar</button>
                            <button class="btn btn-liquidar" onclick="liquidar('${nombre}')">âœ… Liquidar</button>
                        </td>
                    </tr>
                `;
            }
            if (tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No hay deudas.</td></tr>';
        }

        async function hacerAbono(nombre, saldo) {
            const monto = parseFloat(prompt(`Entrega de ${nombre}:`));
            if (isNaN(monto) || monto <= 0) return;
            
            // Buscamos una venta de este cliente para aplicarle el pago
            const { data } = await client.from('ventas').select('*').eq('cliente_nombre', nombre).eq('metodo_pago', 'libreta').limit(1).single();
            if (data) {
                const nuevoAbono = (data.pago_parcial || 0) + monto;
                await client.from('ventas').update({ pago_parcial: nuevoAbono }).eq('id', data.id);
                cargarCuentas();
            }
        }

        async function liquidar(nombre) {
            if (confirm(`Â¿Saldar toda la deuda de ${nombre}?`)) {
                await client.from('ventas').update({ metodo_pago: 'efectivo' }).eq('cliente_nombre', nombre).eq('metodo_pago', 'libreta');
                cargarCuentas();
            }
        }

        // Iniciar
        verificarAcceso();
        cargarCuentas();
    </script>
</body>
</html>