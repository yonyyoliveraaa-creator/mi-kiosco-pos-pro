<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>KIOSCO POS - Ventas</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #fff; --accent: #2ecc71; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        /* MENU LATERAL */
        .sidenav { height: 100%; width: 0; position: fixed; z-index: 1001; top: 0; left: 0; background: #111; transition: 0.3s; padding-top: 60px; overflow-x: hidden; }
        .sidenav a { padding: 15px 25px; text-decoration: none; font-size: 1.1rem; color: #818181; display: block; border-bottom: 1px solid #222; cursor: pointer; }
        .sidenav a:hover { color: var(--accent); }
        .open-btn { font-size: 24px; cursor: pointer; position: fixed; top: 20px; left: 20px; background: none; border: none; color: white; z-index: 1000; }

        .container { max-width: 1200px; margin: 60px auto 0; display: grid; grid-template-columns: 1fr 400px; gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border-bottom: 4px solid var(--accent); position: relative; }
        
        input, select { width: 100%; padding: 12px; background: #2d2d2d; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; font-size: 1rem; margin-top: 5px; }
        
        #resultados-busqueda { background: #252525; border-radius: 0 0 8px 8px; position: absolute; z-index: 100; width: 100%; max-height: 200px; overflow-y: auto; }
        .res-item { padding: 12px; border-bottom: 1px solid #333; cursor: pointer; }
        .res-item:hover { background: #333; color: var(--accent); }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; color: #888; border-bottom: 1px solid #333; padding: 10px; }
        td { padding: 10px; border-bottom: 1px solid #222; }

        .logo { font-size: 1.8rem; font-weight: bold; text-align: center; margin-bottom: 20px; }
        .k-verde { color: var(--accent); }
        .total-box { font-size: 3rem; font-weight: bold; text-align: center; color: var(--accent); background: #111; border-radius: 8px; padding: 15px; margin: 10px 0; }
        
        .seccion-pago { background: #252525; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .label-pago { color: #888; font-size: 0.8rem; text-transform: uppercase; margin-top: 10px; display: block; }
        .vuelto-box { font-size: 2.5rem; font-weight: bold; text-align: center; color: #f1c40f; margin-top: 10px; }
        
        .btn-cobrar { width: 100%; padding: 20px; background: var(--accent); color: white; border: none; border-radius: 12px; font-size: 1.4rem; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .btn-calc { background: #3498db; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }

        #modal-peso { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; }
    </style>
</head>
<body>

    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" onclick="closeNav()" style="font-size:30px; position:absolute; top:10px; right:25px; color:white;">&times;</a>
        <a href="ventas.html">üõí Ventas</a>
        <div id="menu-admin" style="display: none;">
            <a href="index.html">üì¶ Inventario</a>
            <a href="libreta.html">üìñ Libreta Fiados</a>
            <a href="reportes.html">üìä Reportes</a>
            <a href="usuario.html">üë• Gesti√≥n de Personal</a>
        </div>
        <a href="#" onclick="cerrarSesion()" style="color: #ff4757; margin-top: 20px;">üö™ Cerrar Sesi√≥n</a>
    </div>

    <button class="open-btn" onclick="openNav()">&#9776;</button>

    <div class="container">
        <div class="card">
            <h2 style="margin-top:0">üõí Venta Actual</h2>
            <div style="position: relative;">
                <input type="text" id="buscador-manual" placeholder="üîç Buscar por nombre o c√≥digo..." onkeyup="buscarPorNombre(this.value)">
                <div id="resultados-busqueda"></div>
            </div>
            <table>
                <thead>
                    <tr><th>Producto</th><th>Precio</th><th>Cant / Peso</th><th>Subtotal</th><th></th></tr>
                </thead>
                <tbody id="carrito-body"></tbody>
            </table>
        </div>

        <div class="card">
            <div class="logo"><span class="k-verde">K</span>IOSCO POS</div>
            <span class="label-pago">Total a Pagar</span>
            <div class="total-box" id="total-venta">$ 0.00</div>
            
            <div class="seccion-pago">
                <span class="label-pago">Metodo de Pago</span>
                <select id="metodo-pago" onchange="toggleInputsPago()">
                    <option value="efectivo">üíµ Efectivo</option>
                    <option value="debito">üí≥ Tarjeta D√©bito</option>
                    <option value="credito">üí≥ Tarjeta Cr√©dito</option>
                    <option value="transferencia">üì± Transferencia / QR</option>
                    <option value="libreta">üìñ Libreta (Fiado)</option>
                </select>

                <div id="area-vuelto">
                    <span class="label-pago">Paga con:</span>
                    <input type="number" id="paga-con" placeholder="0.00" onkeyup="calcularVuelto()">
                    <span class="label-pago">Su Vuelto:</span>
                    <div class="vuelto-box" id="vuelto-display">$ 0.00</div>
                </div>

                <div id="area-libreta" style="display:none;">
                    <span class="label-pago">Nombre del Cliente:</span>
                    <input type="text" id="nombre-cliente" placeholder="Ej: Juan Perez">
                </div>
            </div>
            <button class="btn-cobrar" onclick="finalizarVenta()">FINALIZAR VENTA</button>
        </div>
    </div>

    <div id="modal-peso">
        <div class="card" style="width:300px; text-align:center;">
            <h3>Calcular por Dinero</h3>
            <p id="peso-prod-nombre" style="color:#888"></p>
            <input type="number" id="monto-dinero" placeholder="¬øCu√°nto dinero?">
            <div style="margin-top:15px; display:flex; gap:10px;">
                <button onclick="confirmarPeso()" style="flex:1; padding:10px; background:var(--accent); border:none; color:white; border-radius:8px; cursor:pointer;">Aplicar</button>
                <button onclick="cerrarModalPeso()" style="flex:1; padding:10px; background:#444; border:none; color:white; border-radius:8px; cursor:pointer;">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        const client = supabase.createClient('https://ovctgqmhumlspklhbjhf.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92Y3RncW1odW1sc3BrbGhiamhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMTcyOTEsImV4cCI6MjA4Mzc5MzI5MX0.6PrQwbYrjDZqo_Zku3uM-z7Bt3-Dn59cMbl5l9KAo_Q');
        let carrito = [];
        let itemParaPeso = null;

        // --- 1. SEGURIDAD Y MENU ---
        verificarAcceso();
        function verificarAcceso() {
            const rol = localStorage.getItem('rol');
            if (!rol) { window.location.href = 'login.html'; return; }
            const menuAdmin = document.getElementById('menu-admin');
            if (rol === 'due√±o' || rol === 'encargada') { if (menuAdmin) menuAdmin.style.display = 'block'; }
        }
        function openNav() { document.getElementById("mySidenav").style.width = "250px"; }
        function closeNav() { document.getElementById("mySidenav").style.width = "0"; }
        function cerrarSesion() { localStorage.clear(); window.location.href = 'login.html'; }

        // --- 2. LECTOR DE BARRAS (Broadcast corregido) ---
        client.channel('ventas').on('broadcast', { event: 'escaneo' }, async (p) => {
            const cod = p.payload.codigo.trim();
            const { data } = await client.from('productos').select('*').eq('codigo_barra', cod).single();
            if (data) { agregarAlCarrito(data); }
            else { console.log("C√≥digo no encontrado: " + cod); }
        }).subscribe();

        // --- 3. BUSCADOR Y CARRITO ---
        async function buscarPorNombre(v) {
            const lista = document.getElementById('resultados-busqueda');
            if (v.length < 2) { lista.innerHTML = ''; return; }
            const { data } = await client.from('productos').select('*').ilike('nombre', `%${v}%`).limit(5);
            lista.innerHTML = '';
            data.forEach(p => {
                const item = document.createElement('div');
                item.className = 'res-item';
                item.innerHTML = `<b>${p.nombre}</b> - $${p.precio_venta}`;
                item.onclick = () => { agregarAlCarrito(p); document.getElementById('buscador-manual').value = ''; lista.innerHTML = ''; };
                lista.append(item);
            });
        }

        function agregarAlCarrito(p) {
            const ex = carrito.find(i => i.id === p.id);
            if (ex) ex.cantidad += 1; else carrito.push({ ...p, cantidad: 1 });
            actualizarTabla();
        }

        function actualizarTabla() {
            const tbody = document.getElementById('carrito-body');
            tbody.innerHTML = '';
            let total = 0;
            carrito.forEach(p => {
                const sub = p.precio_venta * p.cantidad;
                total += sub;
                tbody.innerHTML += `<tr>
                    <td>${p.nombre}</td>
                    <td>$${p.precio_venta}</td>
                    <td>
                        <input type="number" step="0.001" class="input-qty" value="${p.cantidad}" onchange="editCant('${p.id}', this.value)" style="width:65px; background:#333; color:white; border:none; padding:5px;">
                        <button class="btn-calc" onclick="abrirModalPeso('${p.id}')">‚öñÔ∏è</button>
                    </td>
                    <td>$${sub.toFixed(2)}</td>
                    <td onclick="eliminar('${p.id}')" style="cursor:pointer; color:red">üóëÔ∏è</td>
                </tr>`;
            });
            document.getElementById('total-venta').innerText = `$ ${total.toFixed(2)}`;
            calcularVuelto();
        }

        function editCant(id, v) { 
            const item = carrito.find(i => i.id === id);
            if(item) { item.cantidad = parseFloat(v) || 0; actualizarTabla(); }
        }
        function eliminar(id) { carrito = carrito.filter(i => i.id !== id); actualizarTabla(); }

        // --- 4. LOGICA DE PAGO Y VUELTO ---
        function calcularVuelto() {
            const total = parseFloat(document.getElementById('total-venta').innerText.replace('$ ',''));
            const pago = parseFloat(document.getElementById('paga-con').value) || 0;
            const vuelto = pago > 0 ? pago - total : 0;
            document.getElementById('vuelto-display').innerText = `$ ${vuelto.toFixed(2)}`;
        }

        function toggleInputsPago() {
            const m = document.getElementById('metodo-pago').value;
            document.getElementById('area-vuelto').style.display = (m === 'efectivo') ? 'block' : 'none';
            document.getElementById('area-libreta').style.display = (m === 'libreta') ? 'block' : 'none';
        }

        // --- 5. MODAL PESO ---
        function abrirModalPeso(id) {
            itemParaPeso = carrito.find(i => i.id === id);
            document.getElementById('peso-prod-nombre').innerText = itemParaPeso.nombre;
            document.getElementById('modal-peso').style.display = 'flex';
        }
        function cerrarModalPeso() { document.getElementById('modal-peso').style.display = 'none'; }
        function confirmarPeso() {
            const monto = document.getElementById('monto-dinero').value;
            if(monto && itemParaPeso) {
                itemParaPeso.cantidad = parseFloat((monto / itemParaPeso.precio_venta).toFixed(3));
                actualizarTabla();
            }
            cerrarModalPeso();
        }

        // --- 6. FINALIZAR VENTA ---
        async function finalizarVenta() {
            if (carrito.length === 0) return;
            const total = parseFloat(document.getElementById('total-venta').innerText.replace('$ ',''));
            const metodo = document.getElementById('metodo-pago').value;
            const cliente = document.getElementById('nombre-cliente').value;

            if (metodo === 'libreta' && !cliente) {
                alert("‚ö†Ô∏è Por favor, ingresa el nombre del cliente para el fiado.");
                return;
            }

            const { error } = await client.from('ventas').insert([{
                productos: carrito, 
                total: total,
                metodo_pago: metodo,
                cliente_nombre: cliente || null,
                vendedor: localStorage.getItem('usuario'), 
                fecha: new Date().toISOString()
            }]);

            if (!error) {
                alert("‚úÖ Venta Guardada");
                carrito = []; 
                document.getElementById('paga-con').value = ''; 
                document.getElementById('nombre-cliente').value = '';
                actualizarTabla();
            } else { 
                alert("Error al guardar: " + error.message); 
            }
        }
    </script>
</body>
</html>